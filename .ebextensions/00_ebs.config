#
#  - find any loose volumes and hook them up
#  - if there are any found, set a boolean in the ajs-launch.json file
#

packages:
   yum:
      jq: []

commands:
  01-attach-volumes:
    command: |-
      export AWS_CONFIG_FILE="/aws-config/awscredentials.config" && \
      AWS_AVAILABILITY_ZONE=$(/opt/aws/bin/ec2-metadata --availability-zone | cut -c12- | rev | cut -c 1- | rev)

      EC2_INSTANCE_ID=$(/opt/aws/bin/ec2-metadata --instance-id | cut -c14-) && \

      VOLUME_IDS_STRING=$( \
        aws ec2 describe-volumes | \
        jq '.Volumes[]' | \
        jq 'if .State == "available"
          and .AvailabilityZone == "'$AWS_AVAILABILITY_ZONE'"
          and .Tags[0].Key == "blog"
          and .Tags[0].Value == "unboundev"
          then .VolumeId else "" end' \
      ) && \

      VOLUME_ID=${VOLUME_IDS_STRING//\"} && \
      echo "VOLUME_ID: "$VOLUME_ID && \

      #attach volume if need be
      if [ $VOLUME_ID != "\"\"" ]; \
        then aws ec2 attach-volume --volume-id ${VOLUME_ID//\"} --instance-id ${EC2_INSTANCE_ID//\"} --device "/dev/sdf" ; \
        sleep 10 ; \
      fi \

      #mount the volume if need be
      if [ ! -d /vol ]; then \
        mkdir /vol ; \
        mount /dev/xvdf /vol ; \
      fi
